// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  RBT
  CANDIDATE
}

enum PreferredContactMethod {
  EMAIL
  TEXT
  CALL
}

enum RBTStatus {
  NEW
  REACH_OUT
  REACH_OUT_EMAIL_SENT
  TO_INTERVIEW
  INTERVIEW_SCHEDULED
  INTERVIEW_COMPLETED
  HIRED
  REJECTED
}

enum InterviewStatus {
  SCHEDULED
  COMPLETED
  NO_SHOW
  CANCELED
}

enum InterviewDecision {
  PENDING
  OFFERED
  REJECTED
}

enum InterviewRecommendation {
  SUGGEST_HIRING
  SUGGEST_REJECTING
  STALLING
}

enum OnboardingTaskType {
  DOWNLOAD_DOC
  UPLOAD_SIGNED_DOC
  VIDEO_COURSE
  TRAINING_LINK
  SIGNATURE
  PACKAGE_UPLOAD
  FORTY_HOUR_COURSE_CERTIFICATE
}

enum ShiftStatus {
  SCHEDULED
  COMPLETED
  CANCELED
}

enum TimeEntrySource {
  MOBILE_APP
  WEB_MANUAL
}

enum LeaveType {
  SICK
  VACATION
  PERSONAL
  OTHER
}

enum LeaveRequestStatus {
  PENDING
  APPROVED
  DENIED
}

enum EmailTemplateType {
  REACH_OUT
  INTERVIEW_INVITE
  OFFER
  REJECTION
}

enum OnboardingDocumentType {
  ACKNOWLEDGMENT
  FILLABLE_PDF
}

enum OnboardingCompletionStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

enum ApplicationSource {
  ADMIN_CREATED
  PUBLIC_APPLICATION
}

model User {
  id          String   @id @default(cuid())
  name        String?
  phoneNumber String?  @unique
  email       String?  @unique
  role        UserRole @default(CANDIDATE)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rbtProfile RBTProfile?
  profile    UserProfile?
  sessions   Session[]

  @@map("users")
}

model UserProfile {
  id                          String                 @id @default(cuid())
  userId                      String                 @unique
  fullName                    String?
  preferredName               String?
  phone                        String?
  address                     String?
  timezone                    String?
  preferredContactMethod      PreferredContactMethod?
  bio                         String?                @db.Text
  skills                      String[]
  languages                   String[]
  emergencyContactName        String?
  emergencyContactRelationship String?
  emergencyContactPhone       String?
  profileImageUrl             String?                @db.Text
  employeeId                  String?
  startDate                   DateTime?
  department                  String?
  title                       String?
  rbtCertificationNumber      String?
  rbtCertificationExpiresAt   DateTime?
  createdAt                   DateTime               @default(now())
  updatedAt                   DateTime               @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  device    String?
  browser   String?
  ipAddress String?
  lastActiveAt DateTime?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model OtpCode {
  id          String   @id @default(cuid())
  phoneNumber String?
  email       String?
  code        String
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  used        Boolean  @default(false)

  @@index([phoneNumber, code])
  @@index([email, code])
  @@map("otp_codes")
}

model RBTProfile {
  id                       String             @id @default(cuid())
  userId                   String             @unique
  firstName                String
  lastName                 String
  phoneNumber              String
  email                    String?
  locationCity             String?
  locationState            String?
  zipCode                  String?
  addressLine1             String?
  addressLine2             String?
  preferredServiceArea     String?
  notes                    String?
  gender                   String?
  fortyHourCourseCompleted Boolean            @default(false)
  status                   RBTStatus          @default(NEW)
  scheduleCompleted        Boolean            @default(false)
  source                   ApplicationSource? @default(ADMIN_CREATED)
  submittedAt              DateTime?
  resumeUrl                String?            @db.Text
  resumeFileName           String?
  resumeMimeType           String?
  resumeSize               Int?
  availabilityJson         Json?
  languagesJson            Json?
  experienceYears          Int?
  transportation           Boolean?
  preferredHoursRange      String?
  schedulingToken         String?              @unique
  createdAt                DateTime           @default(now())
  updatedAt                DateTime           @updatedAt

  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  interviews            Interview[]
  onboardingTasks       OnboardingTask[]
  shifts                Shift[]
  timeEntries           TimeEntry[]
  leaveRequests         LeaveRequest[]
  interviewEmailLogs    InterviewEmailLog[]
  availabilitySlots     AvailabilitySlot[]
  documents             RBTDocument[]
  interviewNotes        InterviewNotes[]
  onboardingCompletions OnboardingCompletion[]
  auditLogs             RBTAuditLog[]

  @@map("rbt_profiles")
}

model Interview {
  id              String            @id @default(cuid())
  rbtProfileId    String
  scheduledAt     DateTime
  durationMinutes Int               @default(60)
  interviewerName String
  status          InterviewStatus   @default(SCHEDULED)
  decision        InterviewDecision @default(PENDING)
  meetingUrl      String?
  notes           String?
  reminderSentAt  DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  rbtProfile     RBTProfile      @relation(fields: [rbtProfileId], references: [id], onDelete: Cascade)
  interviewNotes InterviewNotes?

  @@map("interviews")
}

model InterviewEmailLog {
  id           String            @id @default(cuid())
  rbtProfileId String
  templateType EmailTemplateType
  sentAt       DateTime          @default(now())
  toEmail      String
  subject      String
  status       String?
  body         String?           @db.Text

  rbtProfile RBTProfile @relation(fields: [rbtProfileId], references: [id], onDelete: Cascade)

  @@map("interview_email_logs")
}

model OnboardingTask {
  id                  String             @id @default(cuid())
  rbtProfileId        String
  taskType            OnboardingTaskType
  title               String
  description         String?            @db.Text
  documentDownloadUrl String?            @db.Text
  uploadUrl           String?            @db.Text
  isCompleted         Boolean            @default(false)
  completedAt         DateTime?
  sortOrder           Int                @default(0)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  rbtProfile RBTProfile @relation(fields: [rbtProfileId], references: [id], onDelete: Cascade)

  @@index([rbtProfileId, isCompleted])
  @@map("onboarding_tasks")
}

model Shift {
  id              String      @id @default(cuid())
  rbtProfileId    String
  clientName      String
  clientId        String?
  startTime       DateTime
  endTime         DateTime
  locationAddress String?
  status          ShiftStatus @default(SCHEDULED)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  rbtProfile  RBTProfile  @relation(fields: [rbtProfileId], references: [id], onDelete: Cascade)
  timeEntries TimeEntry[]

  @@map("shifts")
}

model TimeEntry {
  id           String          @id @default(cuid())
  rbtProfileId String
  shiftId      String?
  clockInTime  DateTime
  clockOutTime DateTime?
  totalHours   Float?
  source       TimeEntrySource @default(WEB_MANUAL)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  rbtProfile RBTProfile @relation(fields: [rbtProfileId], references: [id], onDelete: Cascade)
  shift      Shift?     @relation(fields: [shiftId], references: [id], onDelete: SetNull)

  @@map("time_entries")
}

model LeaveRequest {
  id           String             @id @default(cuid())
  rbtProfileId String
  startDate    DateTime
  endDate      DateTime
  type         LeaveType
  reason       String?            @db.Text
  status       LeaveRequestStatus @default(PENDING)
  adminNotes   String?            @db.Text
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  rbtProfile RBTProfile @relation(fields: [rbtProfileId], references: [id], onDelete: Cascade)

  @@map("leave_requests")
}

model AvailabilitySlot {
  id           String   @id @default(cuid())
  rbtProfileId String
  dayOfWeek    Int // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
  hour         Int // 14 to 21 (representing 2 PM-3 PM, 3 PM-4 PM, ..., 9 PM-10 PM)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  rbtProfile RBTProfile @relation(fields: [rbtProfileId], references: [id], onDelete: Cascade)

  @@unique([rbtProfileId, dayOfWeek, hour])
  @@map("availability_slots")
}

model InterviewNotes {
  id            String @id @default(cuid())
  interviewId   String @unique
  rbtProfileId  String
  scriptVersion String @default("1.0")

  // Structured answers for each question
  greetingAnswer        String? @db.Text
  basicInfoAnswer       String? @db.Text
  experienceAnswer      String? @db.Text
  heardAboutAnswer      String? @db.Text
  abaPlatformsAnswer    String? @db.Text
  communicationAnswer   String? @db.Text
  availabilityAnswer    String? @db.Text
  payExpectationsAnswer String? @db.Text
  previousCompanyAnswer String? @db.Text
  expectationsAnswer    String? @db.Text
  closingNotes          String? @db.Text

  // Additional structured fields for basic info
  fullName       String?
  birthdate      String?
  currentAddress String? @db.Text
  phoneNumber    String?

  // Recommendation from interviewer (temporarily commented until migration is run)
  // recommendation          InterviewRecommendation?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  interview  Interview  @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  rbtProfile RBTProfile @relation(fields: [rbtProfileId], references: [id], onDelete: Cascade)

  @@map("interview_notes")
}

model RBTDocument {
  id           String   @id @default(cuid())
  rbtProfileId String
  fileName     String
  fileType     String // MIME type
  fileData     String   @db.Text // base64 encoded file
  documentType String? // 'RESUME', 'CERTIFICATION', 'OTHER'
  uploadedAt   DateTime @default(now())

  rbtProfile RBTProfile @relation(fields: [rbtProfileId], references: [id], onDelete: Cascade)

  @@map("rbt_documents")
}

model OnboardingDocument {
  id        String                 @id @default(cuid())
  title     String
  slug      String                 @unique
  type      OnboardingDocumentType
  pdfUrl    String?                @db.Text // URL or path to the PDF file
  pdfData   String?                @db.Text // base64 encoded PDF (alternative to pdfUrl)
  sortOrder Int                    @default(0)
  isActive  Boolean                @default(true)
  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt

  completions OnboardingCompletion[]

  @@map("onboarding_documents")
}

model OnboardingCompletion {
  id                 String                     @id @default(cuid())
  rbtProfileId       String
  documentId         String
  status             OnboardingCompletionStatus @default(NOT_STARTED)
  completedAt        DateTime?
  acknowledgmentJson Json? // Stores acknowledgment data (name, checkboxes, timestamp, etc.)
  signedPdfUrl       String?                    @db.Text // URL or path to the signed/completed PDF (Supabase Storage path)
  signedPdfData      String?                    @db.Text // base64 encoded signed PDF (legacy/backward compatibility)
  storageBucket      String? // Supabase Storage bucket name (e.g., 'onboarding-documents')
  fieldValues        Json? // Stores extracted field values for debugging/audit
  draftData          Json? // Stores draft form field data for fillable PDFs
  createdAt          DateTime                   @default(now())
  updatedAt          DateTime                   @updatedAt

  rbtProfile RBTProfile         @relation(fields: [rbtProfileId], references: [id], onDelete: Cascade)
  document   OnboardingDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([rbtProfileId, documentId])
  @@map("onboarding_completions")
}

model CandidateApplicationDraft {
  id        String    @id @default(cuid())
  email     String
  dataJson  Json
  token     String    @unique
  status    String    @default("IN_PROGRESS")
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([email, status])
  @@index([token])
  @@map("candidate_application_drafts")
}

model RBTAuditLog {
  id           String   @id @default(cuid())
  rbtProfileId String
  auditType    String   // 'PHONE_CALL', 'EMAIL', 'NOTE', etc.
  dateTime     DateTime
  notes        String?  @db.Text
  createdBy    String?  // Admin user email or name
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  rbtProfile RBTProfile @relation(fields: [rbtProfileId], references: [id], onDelete: Cascade)

  @@index([rbtProfileId, dateTime])
  @@map("rbt_audit_logs")
}
